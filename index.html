<script>
(function() {
    // 使用 localStorage 排除同一瀏覽器重複計數
    // 改用新的計數 id（請確認與您目前使用的一致）
    const apiBase = "https://api.counterapi.dev/v1/faye_yoko_game_stats_v2/visits";
    const displayElement = document.getElementById('view-count');
    const visitedKey = 'faye_yoko_visited_v2';
    const lastCountKey = 'faye_yoko_last_count_v2';

    const isAdmin = new URLSearchParams(location.search).get('admin') === '1';

    function showCount(value) {
        if (!displayElement) return;
        displayElement.innerText = (value === null || value === undefined) ? '連線中' : String(value);
    }

    async function fetchCount() {
        // GET 目前數值（不會增加）
        try {
            const res = await fetch(apiBase, { cache: 'no-store' });
            if (!res.ok) throw new Error('fetch / failed');
            const data = await res.json();
            return data.count ?? data.value ?? data;
        } catch (e) {
            console.warn('fetchCount failed', e);
            return null;
        }
    }

    async function incrementCount() {
        try {
            const res = await fetch(apiBase + '/up');
            if (!res.ok) throw new Error('increment failed');
            const data = await res.json();
            return data.count ?? data.value ?? data;
        } catch (e) {
            console.error('incrementCount failed', e);
            return null;
        }
    }

    async function resetCount() {
        const pwd = prompt('請輸入管理密碼以重置計數：');
        if (pwd !== 'RESET_ME') {
            alert('密碼錯誤或已取消');
            return null;
        }

        try {
            const res = await fetch(apiBase + '/reset', { method: 'POST' });
            if (!res.ok) throw new Error('reset request failed');
            const data = await res.json();
            return data.count ?? data.value ?? data;
        } catch (e) {
            console.error('resetCount failed', e);
            alert('重置失敗：伺服端可能不支援遠端重置或需憑證。詳細請參考你的計數服務文件。');
            return null;
        }
    }

    // 週期性取得最新數字並更新畫面（不會對伺服器做 /up）
    async function pollAndUpdate(intervalMs = 8000) {
        // 先立刻抓一次
        const first = await fetchCount();
        if (first !== null) {
            showCount(first);
            localStorage.setItem(lastCountKey, String(first));
        } else {
            const cached = localStorage.getItem(lastCountKey);
            if (cached) showCount(Number(cached));
        }

        // 週期性更新
        return setInterval(async () => {
            const v = await fetchCount();
            if (v !== null) {
                showCount(v);
                localStorage.setItem(lastCountKey, String(v));
            }
        }, intervalMs);
    }

    async function init() {
        const visited = localStorage.getItem(visitedKey) === '1';

        if (!visited) {
            // 尚未被計數：執行加一操作
            const newCount = await incrementCount();
            if (newCount !== null) {
                // 設定為已被計數（只對這個瀏覽器）
                localStorage.setItem(visitedKey, '1');
                localStorage.setItem(lastCountKey, String(newCount));
                showCount(newCount);
            } else {
                // 無法加一時，仍嘗試讀取現有數值
                const fetched = await fetchCount();
                if (fetched !== null) {
                    showCount(fetched);
                    localStorage.setItem(lastCountKey, String(fetched));
                } else {
                    // 顯示緩存或連線中
                    const cached = localStorage.getItem(lastCountKey);
                    showCount(cached ? Number(cached) : null);
                }
            }
        } else {
            // 已被計數：先讀一次伺服器最新值或快取
            const fetched = await fetchCount();
            if (fetched !== null) {
                showCount(fetched);
                localStorage.setItem(lastCountKey, String(fetched));
            } else {
                const cached = localStorage.getItem(lastCountKey);
                showCount(cached ? Number(cached) : null);
            }
        }

        // 啟動週期性 poll（使 A 能看到 B/C 後來的造訪）
        const pollHandle = pollAndUpdate(8000); // 8 秒一請求，可改成 5000 或 10000

        // 管理介面（只在 admin=1 時顯示）
        if (isAdmin) {
            const ctrl = document.getElementById('admin-controls');
            if (ctrl) ctrl.style.display = 'block';
            const btn = document.getElementById('reset-btn');
            if (btn) {
                btn.addEventListener('click', async () => {
                    const result = await resetCount();
                    if (result !== null) {
                        // 不清除本地 visited 標記，這樣被排除的瀏覽器會維持不被重複計數
                        localStorage.setItem(lastCountKey, String(result));
                        showCount(result);
                        alert('已嘗試重置伺服器上的計數（請確認服務端是否真的支援重置）。已保留本機已計數狀態，排除本瀏覽器再次計數。');
                    }
                });
            }
        }

        // 若您想在離開頁面時暫停 poll，可以取消 interval：
        // window.addEventListener('beforeunload', () => clearInterval(pollHandle));
    }

    // 立即啟動
    init();
})();
</script>
